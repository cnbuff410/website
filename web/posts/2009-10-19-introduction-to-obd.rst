=================================
自己监控爱车的信息－OBD系统介绍
=================================
:Author: cnbuff410
:Contact: likunarmstrong@gmail.com

.. contents::

前段时间因为项目的关系，接触了一阵OBD-II系统，觉得很不错，对于喜欢自己DIY的汽车
爱好者来说是值得花时间看一看的，我也准备以后有空就写一下这方面的东西。今天先大
体介绍以下整个系统的概况吧，

OBD简介
===================

OBD是On-board diagnostics的缩写，最早是在1975年的时候提出来的。1980年前后，通用将其实现为标准的接口和协议并用在自家的汽车组装线上，作为调试工具，这个协议当时叫做’assembly line diagnostic link’ (ALDL)。到了1987年，加州就开始强制性要求所有加州的新车都必须具有一定的OBD信息输出，这也就是OBD-I系统的雏形。

1994年的时候，OBD-II规范被提出并进行讨论。1996年1月1日，美国规定，所有汽车和卡车制造出厂在美国销售都必须配有OBD-II装备。01年开始，欧共体也出台相似规定，强制要求欧洲销售车辆具备EOBD系统，这玩意其实就是OBD-II的一种版本。


也就是说，只要你的汽车

- 是在美国买的，并且是在1996年之后生产的
- 是在欧洲购买的，2001年之后的型号，并且是烧汽油的
- 是在欧洲购买的，2004年之后的型号，并且是烧柴油的

那就肯定装有OBD-II系统。我目前不是很清楚国内该系统的普及情况，但相对高端点的汽车现在应该都开始加装这个系统了。

OBD接口介绍
===================

OBD-II车载接口是这样的

.. image:: http://www.obdii.com/images/connectorblue.GIF

标准化的接口定义是

1. -
2. Bus positive Line of SAE-J1850 PWM and SAE-1850 VPW
3. Ford DCL(+) Argentina, Brazil (pre OBD-II) 1997-2000, Usa, Europe, etc.
4. Chassis ground
5. Signal ground
6. CAN high (ISO 15765-4 and SAE-J2284)
7. K line of ISO 9141-2 and ISO 14230-4
8. -
9. -
10. Bus negative Line of SAE-J1850 PWM only (not SAE-1850 VPW)
11. Ford DCL(-) Argentina, Brazil (pre OBD-II) 1997-2000, Usa, Europe, etc.
12. -
13. -
14. CAN low (ISO 15765-4 and SAE-J2284)
15. L line of ISO 9141-2 and ISO 14230-4
16. Battery voltage

未定义的针脚则是留给厂商自己配置的。这些都很好理解，我就不赘述了。

OBD数据介绍
=============

其实最开始的时候，搞OBD的人就是想坚持汽车引擎的排放，以此来判断污染是不是超标了。后来，因为这个系统越来越流行，也越来越标准化，各大厂商就开始将其扩展，把很多的故障信息或者性能信息都放在上面。假如说你的车出问题了，送到修车铺，那大多数修车点都会先用工具从OBD中阅读故障代表并根据此做判断。和前一代的OBD相比，OBD-II标准规定了诊断接头的类型，以及信息格式和针脚定义（参考下图）。同时，OBD-II还提供了一个监测参数的candidate list，以及如何进行对应编码的方法，当然这个不是强制遵循的。更重要的是，OBD-II提供了关于DTC（Diagnostic Trouble Code）的扩展list。得益于上述这些标准化进程， 现在有很多第三方工具可以监测和显示以及记录大部分信息，即使car的品牌型号不同。相应的设备我们之后会有所提及。

那么，OBD-II系统到底输出的是什么信息呢？总的来说可以分为3类

1. Diagnostic Trouble Codes (DTCs)诊断错误码
2. 汽车运行实时数据
3. 冻结帧

DTCs就是简单的错误代码，根据错误代码可以判断汽车当前的问题是什么。这里有DTC简单的对应表，这里则有非常详尽的error code信息。这里需要注意的是，并不是任何时候你都能看到DTCs的输出，通常情况下只有错误提示灯，比如Check Engine Light亮起的时候，才会有相关数据输出。

实时数据则是从汽车传感器中上传到OBD系统的数据，其中一些数据是监测汽车性能的关键，比如当前速度，引擎室温度，RPM等等。

而冻结帧则是实时传感器数据在有错误代码产生时候的snapshot，主要是用来当车子出毛病的时候，参考当时传感器数据来推断当时的情况。

数据协议标准
---------------

OBD-II标准包含了不同的协议来实现汽车与诊断设备之间的数据传输

前三种协议是各路诸侯分别割据的结果，而第四种CAN协议是一个新兴的但普及极快的标准
，以后也将成为事实上的所有汽车的标准。CAN协议已经被欧洲和北美的汽车制造商广泛应
用。 作为战略步骤，新型的 GM 汽车已经完全基于CAN协议。完全支持CAN协议的还包括
2004年后生产的Ford, Jaguar, Mazda, Mercedes, Nissan, and Toyota等等等等。对于
CAN的具体介绍请参见这里。

那你怎么判定你的爱车到底支持的是什么协议呢？你可以通过检查连接针脚来判断。参考
刚才给出的接口针脚示意图，

- J1850 VPW–接头在2, 4, 5和16处有金属针脚, 但是10处没有
- ISO 9141-2–接头在4, 5, 7, 16处有针脚，但在15处可能没有.
- J1850 PWM–接头在2, 4, 5, 10，16处有针脚
- CAN－接头在4，5，6，14和16处都有针脚

OBD工具
==============

硬件工具
-----------

目前市面上主要有两大类OBD-II的硬件工具，一种是单独的主要用于诊断的手持设备，一种是纯电缆，能让OBD接口和你的电脑通信，但需要有相应的软件运行在电脑端。对于普通爱好者来说，一般都会选择第二种，可以DIY，也可以买现成的之后自订制，软件还可以更换和修改，最关键的是不贵，通常也就是10-40美元不等，有
`USB接口 <http://www.scantool.net/scan-tools/obdlink-ci.html>`_ 的，有串口接口的，有
`蓝牙接口 <http://www.scantool.net/scan-tools/obdlink.html>`_
的，都很全，google就能goo出一大堆。当然还有一些就是也是单独的设备，但是主要显示的是各种传感器信息的，比如
`这个 <http://www.scangauge.com/>`_
。但由于硬件和软件绑定，我个人对于这种东西的兴趣不大。

软件工具
-----------

首先需要说明的是，并不是每款OBD工具都可以用在转换电缆上，在使用之前必须确认清楚
你手头的软件和硬件电缆是不是兼容。由于我自己用的电缆就是从Scantool来的，所以我
所用的软件自然也是从上面下的，Scantool_ 最好的一点就是它的cable有一堆的商用软件都
和其兼容，更重要的是它还提供开源的应用程序，虽然是在windows上使用的。如果你想找
Linux下的开源程序研究，可以看看 Freediag_ 。如果你使用的是像Palm这样的手持设备，那
可以去看看 Autotap_ 的产品线。

如何购买适合自己的工具
-------------------------

虽然以后我可能会在Blog上介绍一些自己DIY工具的知识，但也许有的人就想买整套的工具并直接使用。这里就大概说一下如果想买相关工具，需要注意哪些问题？

目前能在互联网上找到的工具五花八门，直接挑很容易就挑花了眼。一般来说，从以下几个方面入手选择：

这套工具能用于你的爱车么？
+++++++++++++++++++++++++++++
    我们都知道OBDII是标准协议，但是具体到硬件层的通信，不同的厂商就会有不同的通信协议了。有一些工具是支持全套的通信协议的，有一些工具则只支持特定厂商汽车的协议。所以在购买之前，首先确定工具所能支持的通信协议是否和你的车辆兼容。

这套工具能支持哪些参数输出？
+++++++++++++++++++++++++++++

    所有强制支持OBD的车辆，被要求输出的信息仅仅是关于排放方面的信息，这些信息由SAE specification J1979 规定。也就是说，很多其他的传感器信息是否输出，怎么输出，是取决于各个厂商的不同决定。而一些低端的设备呢，就仅仅支持读取这些关于排放方面的数据。如果一款工具仅仅支持legislated参数，那就要小心了，而如果一款工具宣称支持enhanced参数集，那这个很可能就是能支持很多别的信息的工具。

这套工具是可升级的么？
++++++++++++++++++++++++
    每一年，汽车厂商都会更新换代各种型号，如果你希望你的scan工具不是在每一次汽车型号更新之后就不能继续使用的话，那你所挑选的工具就必须具有固件可升级性，当然升级可能又是另一笔很大的开销了。

这套工具的说明文档完整么？
+++++++++++++++++++++++++++++

    想一想，假设你费劲千辛万苦，让工具和你的汽车通信成功了，你也能从工具中看到DTC代码了，但你知道具体的代码分别表示什么不同的意义么？一款好的工具，应该尽可能多地把信息呈现给用户，而不是给用户纯数据，然后自己去查询数据所表示的含义。当然，目前大多数的scantool软件都支持图形化显示传感器数据了。

这套工具有没有数据记录功能？
+++++++++++++++++++++++++++++++

    不要觉得这个工具不重要，有几个人能够边开车边分析实时数据的？如果工具有data logging的功能，对你旅途之后分析爱车的性能有着巨大的帮助。

OBD资料汇总
==============

关于OBD方面的书，传说中号称圣经级别的是OBD II Diagnostic Secrets Revealed。另一本非常好的书是Ralph Birnbaum写的Getting to Know OBD II。你可以在
`这里 <http://www.obd-2.com/books.htm>`_
找到它们和其他几乎所有和OBD相关的书的购买链接。

关于CAN总线的资料，可以参考
`Kvaser CAN Protocol Tour <http://www.kvaser.com/can/protocol/index.htm>`_

OBD相关资料中可能出现的
`各种各样的缩写 <http://www.obdii.com/acronyms.html>`_ 。

.. _Scantool: http://www.scantool.net/
.. _Freediag: http://freediag.sourceforge.net/
.. _Autotap: http://www.autotap.com/products.html

